#!/bin/bash
# Copyright (c) 2025-present Shape
# Licensed under the MIT License
#
# Pre-commit hook for SwiftLint (auto-fix enabled)

# Get staged Swift files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

if ! command -v swiftlint &> /dev/null; then
    echo "[ERROR] SwiftLint not installed. Run: brew install swiftlint"
    exit 1
fi

echo "Running SwiftLint..."

# Auto-fix what we can
echo "$STAGED_FILES" | xargs swiftlint lint --fix --quiet

# Re-stage any auto-fixed files
echo "$STAGED_FILES" | xargs git add

# Check for remaining issues
LINT_OUTPUT=$(echo "$STAGED_FILES" | xargs swiftlint lint --strict --quiet 2>&1)
LINT_STATUS=$?

if [ $LINT_STATUS -ne 0 ]; then
    echo "$LINT_OUTPUT"
    echo ""
    echo "[FAILED] SwiftLint found issues that need manual fixes."
    echo "         To skip: git commit --no-verify"
    exit 1
fi

echo "[OK] SwiftLint passed"
